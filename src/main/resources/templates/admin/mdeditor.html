<!DOCTYPE html>
<html lang="zh-cn" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">

    <title>写文章-sblog</title>
    <link rel="stylesheet" th:href="@{/admin/css/x-admin.css}">
    <link rel="icon" href="/favicon.ico">
    <link th:href="@{/admin/mdeditor/css/editormd.css}" rel="stylesheet">
    <link th:href="@{/admin/layui/css/layui.css}" rel="stylesheet">
    <script th:src="@{/js/jquery-2.0.3.min.js}"></script>
    <script th:src="@{/admin/mdeditor/js/editormd.min.js}"></script>
    <style>
        .add_button{
            line-height: 36px;
            background-color: #1E9FFF;
            border-radius: 5px;
        }

    </style>
</head>
<body style="overflow-y: auto">
<div class="layui-layout layui-layout-admin">

    <div th:replace="admin/fragment/menu::header"></div>
    <div th:replace="admin/fragment/menu::left"></div>



    <div class="layui-tab layui-tab-card site-demo-title x-main" lay-filter="x-tab" lay-allowclose="true" style="left: 200px;border-left: solid 2px #2299ee;overflow-x: hidden;overflow-y: auto">
        <div  style="margin: 50px 15px">

            <form class="layui-form" action="">

                <!--博客主键id -->
                <input type="hidden" name="id" th:value="${articleId}" lay-verify="required"  placeholder="文章id" class="layui-input">
                <!--编辑器类型 -->
                <input type="hidden" name="editorType" value="1">

                <div class="layui-form-item">

                    <input type="text" name="articleTitle" lay-verify="required" autocomplete="off" placeholder="请输入标题" class="layui-input">

                </div>

                <div class="layui-form-item">
                    <div id="my-editormd">

                        <textarea id="articleContent" name="articleContent" lay-verify="required" lay-reqtext="文章内容是必填项，岂能为空？"  style="display:none;"></textarea>

                    </div>
                </div>


                <div class="layui-form-item">
                    <label class="layui-form-label">文章设置</label>
                    <div class="layui-input-block">
                        <input type="checkbox" name="isprivacy" title="私密文章" value="1">
                        <input type="checkbox" name="like[read]" title="开启评论" value="1">
                        <input type="checkbox" name="istop" title="是否置顶" value="1">
                    </div>
                </div>

                <div class="layui-form-item">

                    <div class="layui-inline">
                        <label class="layui-form-label">博客分类</label>
                        <div class="layui-input-inline">
                            <select name="categories" id="mdeditor_categories" lay-verify="required" lay-search="" >
                                <option th:fragment="mdeditor_categories" th:each="categories,stat:${categoriesList}" th:text="${categories.name}" th:value="${categories.id}">直接选择或搜索选择</option>
                            </select>
                        </div>
                        <div class="layui-input-inline" id="article_categories_add" style="display: none">
                            <div class="layui-input-inline" style="width:120px">
                                <input type="text" name="categoriesName"  placeholder="分类名" autocomplete="off" class="layui-input">
                            </div>
                            <div class="layui-input-inline" style="width:50px">
                                <a href="#" onclick="saveCategories()" style="display: inline;height: 38px;line-height: 38px"><i class="layui-icon layui-icon-ok" style="color: #00d95a"></i></a>
                                <a href="#" onclick="quit(this)" style="display: inline;height: 38px;line-height: 38px"><i class="layui-icon layui-icon-close" style="color: #9d1e15"></i></a>
                            </div>

                        </div>
                        <div class="layui-input-inline" >
                            <a href="#" class="add_button" onclick="addCategories()"><i class="layui-icon layui-icon-add-1" style="color: white"></i></a>
                            添加分类
                        </div>
                    </div>
                </div>

                <div class="layui-form-item" pane="">
                    <label class="layui-form-label">博客标签</label>
                    <div class="layui-input-block checked">
                        <div class="layui-input-inline" style="width: auto" id="article_labels_checked">

                        </div>
                        <div class="layui-input-inline" style="width: auto;display: none" id="article_labels_add" >
                            <div class="layui-input-inline" style="width:120px">
                                <input type="text" name="labelName"  placeholder="标签名" autocomplete="off" class="layui-input">
                            </div>
                            <div class="layui-input-inline" style="width:50px">
                                <a href="#" onclick="saveLable()" style="display: inline;height: 38px;line-height: 38px"><i class="layui-icon layui-icon-ok" style="color: #00d95a"></i></a>
                                <a href="#" onclick="quit(this)" style="display: inline;height: 38px;line-height: 38px"><i class="layui-icon layui-icon-close" style="color: #9d1e15"></i></a>
                            </div>
                        </div>
                        <div class="layui-input-inline">
                            <a href="#" class="add_button" onclick="addLabel()"><i class="layui-icon layui-icon-add-1" style="color: white"></i></a>
                            添加标签
                        </div>
                    </div>

                </div>
                <div class="layui-form-item">
                    <label class="layui-form-label"></label>
                    <div class="layui-input-block all" id="article_labels_all" >
                        <input type="checkbox" name="label" th:fragment="mdeditor_labels" th:each="label,stat:${labels}" th:value="${label.id}" th:title="${label.name}" lay-filter="labels" lay-skin="primary">
                    </div>
                </div>
                <div class="layui-form-item">
                    <label class="layui-form-label"></label>
                    <div class="layui-input-block">
                        <button type="button" class="layui-btn layui-btn-normal" lay-submit="" lay-filter="save">立即提交</button>
                        <button type="button" class="layui-btn layui-btn-warm" lay-submit="" lay-filter="draft">保存草稿</button>
                        <button type="button" class="layui-btn layui-btn-danger" lay-submit="" lay-filter="demo1">返回列表</button>

                    </div>
                </div>
                <div class="layui-form-item">
                    <label class="layui-form-label"></label>
                    <div class="layui-input-block">

                    </div>
                </div>
            </form>

        </div>

    </div>

</div>
</body>

<script th:src="@{/admin/layui/layui.js}" charset="utf-8"></script>
<script th:src="@{/admin/js/x-layui.js}"></script>
<script th:src="@{/admin/js/x-admin.js}"></script>

<script type="text/javascript">

    $(function() {

        let md_edit = editormd("my-editormd", {//注意1：这里的就是上面的DIV的id属性值
            width : "100%",
            height : $(window).height()*(0.8),
            syncScrolling : "single",
            path : "../admin/mdeditor/lib/",//注意2：你的路径
            emoji : true,
            saveHTMLToTextarea : true,//注意3：这个配置，方便post提交表单
            /* 上传图片配置 */
            imageUpload : true,
            /*imageFormats : [ "jpg", "jpeg", "gif", "png", "bmp", "webp" ],*/
            imageUploadURL : "/upload2", //注意你后端的上传图片服务地址
            onload: function() {
                // 引入插件 执行监听方法
                editormd.loadPlugin("../admin/mdeditor/plugins/image-dialog/image-handle-paste", function(){
                    md_edit.imagePaste();
                });
            }
        });

        layui.use(['form'], function(){
            let form = layui.form;

            //监听提交
            form.on('submit(save)', function(data){

                let params = {};

                let field = data.field;
                field['isDraft'] = 0;
                field['articleHtmlContent'] = field['my-editormd-html-code'];
                params['article'] = field;
                let labels = [];
                $("input:checkbox[name='label']:checked").each(function () {
                    labels.push({'aId':$("input[name='id']").val(),'bId':$(this).val()});
                });
                params['labels'] = labels;
                params['categories'] = {'aId':$("input[name='id']").val(),'bId':field.categories};

                save(params);
                return false;
            });
            form.on('submit(draft)', function(data){
                let field = data.field;
                field['isDraft'] = 1;

                return;
                save(field);
                return false;
            });
            form.on('checkbox(labels)', function(data){
                console.log(data);
                let othis = (data.othis)[0];
                let elem = data.elem;
                if($(othis).parent('#article_labels_checked').length == 1){
                    $(othis).removeClass();
                    $(othis).addClass('layui-unselect layui-form-checkbox layui-form');
                    $("#article_labels_all").append(elem);
                    $("#article_labels_all").append(othis);
                }else{
                    if($("#article_labels_checked").children().length == 5){
                        layer.msg("最多只能选5个标签");
                    }else{
                        $(othis).removeClass();
                        $(othis).addClass('layui-unselect layui-form-checkbox layui-form-checked');
                        $("#article_labels_checked").append(elem);
                        $("#article_labels_checked").append(othis);
                    }
                }
            });
        });

    });

    function save(e){

        let data = JSON.stringify({'fieldMap':e})
        $.ajax({
            method:'post',
            contentType:'application/json',
            url:'/admin/article/save',
            data:data,
            success:function(e){

            }
        })

    }

    function addCategories(){
        $("input[name='categoriesName']").val('');
        $("#article_categories_add").css("display","block");
    }

    function addLabel(){

        if($("#article_labels_checked").find("input").length == 5){
            layer.msg("最多只能选5个标签");
            return;
        }
        $("input[name='labelName']").val('');
        $("#article_labels_add").css("display","block");
    }
    function quit(e){


    }


    function saveLable(){
        $.ajax({
            url:'/admin/label/add',
            data:{'name':$("input[name='labelName']").val()},
            success:function (data) {

                let newLabel = $(data)[0];
                $(newLabel).prop("checked",true);
                $("#article_labels_checked").append(newLabel);
                $("#article_labels_add").css("display","none");

                layui.use('form', function() {
                    let form = layui.form; //只有执行了这一步，部分表单元素才会自动修饰成功
                    form.render();
                });

            }
        })
    }

    function saveCategories(){
        $.ajax({
            url:'/admin/categories/add',
            method:'POST',
            data:{'text':$("input[name='categoriesName']").val()},
            success:function (data) {
                $("#mdeditor_categories").html(data);
                $("#article_categories_add").css("display","none");
                layui.use('form', function() {
                    let form = layui.form; //只有执行了这一步，部分表单元素才会自动修饰成功
                    form.render();
                });
                $($("dd").children(":first")).click();
            }
        })
    }
</script>

</html>